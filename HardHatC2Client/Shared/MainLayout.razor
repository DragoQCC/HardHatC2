@using Blazored.Toast.Configuration
@using HardHatCore.HardHatC2Client.Pages
@using HardHatCore.HardHatC2Client.Services
@using System.Net;

@inherits LayoutComponentBase
@implements IDisposable
@inject HotKeys HotKeys
@inject IJSRuntime js
@inject Blazored.LocalStorage.ILocalStorageService LocalStorageService


<BlazoredToasts Position="ToastPosition.BottomRight"
                IconType="IconType.FontAwesome"
                SuccessIcon="fas fa-thumbs-up"
                ErrorIcon="fas fa-bug"
                InfoIcon="fas fa-info-circle"
                WarningIcon="fas fa-exclamation-triangle"
                SuccessClass="success-toast-override"
                Timeout="6"
                ShowCloseButton="true"
                ShowProgressBar="true" />

<MudThemeProvider Theme="theDefaultTheme" @bind-IsDarkMode="@IsDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />

@if (Login.isVisible)
{
    @if (Login.IsLoggedIn)
    {
        Login.isVisible = false;
    }
    <MudOverlay Visible="Login.isVisible" DarkBackground="true" Absolute="true">
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
    </MudOverlay>
}

@if (Login.IsLoggedIn)
{
    <MudLayout>
        @* <MudThemeManager Open="_themeManagerOpen" OpenChanged="OpenThemeManager" Theme="_themeManager" ThemeChanged="UpdateTheme" /> *@
        <MudAppBar Dense="true" Elevation="5">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
            <MudImage Src="Images/hardhat c2-orange - just helmet large.svg" Width="50"></MudImage>
            <MudText Color="Color.Inherit" Typo="Typo.h6">HardHat C2</MudText>
            <MudSpacer />
            <GlobalPalette @ref="globalPalette"></GlobalPalette>
            <MudSpacer />
            @if (TeamServerStatus.Equals("online", StringComparison.CurrentCultureIgnoreCase))
            {
                <MudIcon Class="mx-2" Title="Teamserver Status" Icon="@Icons.Material.Outlined.CheckCircle" Color="Color.Success"></MudIcon>
            }
            else if (TeamServerStatus.Equals("offline", StringComparison.CurrentCultureIgnoreCase))
            {
                <MudIcon Class="mx-2" Title="Teamserver Status" Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error"></MudIcon>
            }
            else
            {
                <MudIcon Class="mx-2" Title="Teamserver Status" Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Warning"></MudIcon>
            }

            <MudIconButton Title="Github" Class="mx-2" Href="https://github.com/DragoQCC/HardHatC2"
                           Target="_blank"
                           Variant="Variant.Filled"
                           Icon="@Icons.Custom.Brands.GitHub"
                           Color="Color.Tertiary">
            </MudIconButton>

            <MudIconButton Title="Discord Community" Class="mx-2" Href="https://discord.gg/npW2yy7JFK"
                           Target="_blank"
                           Variant="Variant.Filled"
                           Icon="@Icons.Custom.Brands.Discord"
                           Color="Color.Tertiary">
            </MudIconButton>


            <MudSwitch Checked="@IsDarkMode" CheckedChanged="((e) => ChangeThemeAsync(e))" 
            ThumbIcon="@(IsDarkMode ? @Icons.Material.Filled.DarkMode : Icons.Material.Filled.LightMode)" T="bool" />
            <MudMenu Class="mx-2" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudAvatar>
                        <MudIcon Icon="@MaterialDesignIcons.Normal.AccountHardHat" />
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Disabled="true">Welcome @Login.SignedInUser</MudMenuItem>
                    <MudMenuItem OnClick="NavigateToSettings">Settings</MudMenuItem>
                    <MudMenuItem OnClick="Login.HandleSignOut">Sign Out</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>
        @if (Login._hhUser != null && Login._hhUser.Roles.Contains("Administrator", StringComparer.OrdinalIgnoreCase))
        {
            <MudDrawer ClipMode="DrawerClipMode.Always" @bind-Open="@isDrawerOpen" Elevation="10" Variant="@DrawerVariant.Mini" OpenMiniOnHover="false">
                <MudNavMenu Color="Color.Warning" Margin="Margin.Dense" Bordered="true">
                    <MudNavLink Class="py-2" href="Index" Icon="@Icons.Material.Outlined.Home" Match="NavLinkMatch.All">Home</MudNavLink>
                    <MudNavLink Class="py-2" href="Objectives" Icon="@Icons.Material.Outlined.Checklist" Match="NavLinkMatch.All">Objectives</MudNavLink>
                    <MudNavLink Class="py-2" href="Settings" Icon="@Icons.Material.Outlined.Settings" Match="NavLinkMatch.All">Settings</MudNavLink>
                </MudNavMenu>
            </MudDrawer>
        }
        else
        {
            <MudDrawer ClipMode="DrawerClipMode.Always" @bind-Open="@isDrawerOpen" Elevation="10" Variant="@DrawerVariant.Mini" OpenMiniOnHover="false">
                <MudNavMenu Color="Color.Warning" Margin="Margin.Dense" Bordered="true">
                    <MudNavLink Class="py-2" href="Index" Icon="@Icons.Material.Outlined.Home" Match="NavLinkMatch.All">Home</MudNavLink>
                    <MudNavLink Class="py-2" href="Managers" Icon="@Icons.Material.Outlined.Headphones" Match="NavLinkMatch.All">Managers</MudNavLink>
                    <MudNavLink Class="py-2" href="Implants" Icon="@Icons.Material.Outlined.Construction" Match="NavLinkMatch.All">Implants</MudNavLink>
                    <MudNavLink Class="py-2" href="ImplantInteract" Icon="@Icons.Material.Outlined.Engineering" Match="NavLinkMatch.All">ImplantInteract</MudNavLink>
                    <MudNavLink Class="py-2" href="Notes" Icon="@Icons.Material.Outlined.Note" Match="NavLinkMatch.All">Notes</MudNavLink>
                    <MudNavLink Class="py-2" href="ReconCenter" Icon="@Icons.Material.Outlined.Keyboard" Match="NavLinkMatch.All">Recon Center</MudNavLink>
                    <MudNavLink Class="py-2" href="ToolBoxes" Icon="@Icons.Material.Outlined.BuildCircle" Match="NavLinkMatch.All">ToolBoxes</MudNavLink>
                    <MudNavLink Class="py-2" href="PivotProxy" Icon="@Icons.Material.Outlined.CompareArrows" Match="NavLinkMatch.All">Pivot Proxy</MudNavLink>
                    <MudNavLink Class="py-2" href="EventHistory" Icon="@Icons.Material.Outlined.History" Match="NavLinkMatch.All">Event History</MudNavLink>
                    <MudNavLink Class="py-2" href="Credentials" Icon="@Icons.Material.Outlined.CreditCard" Match="NavLinkMatch.All">Credentials</MudNavLink>
                    <MudNavLink Class="py-2" href="Downloads" Icon="@Icons.Material.Outlined.Download" Match="NavLinkMatch.All">Downloads</MudNavLink>
                    <MudNavLink Class="py-2" href="HostedFiles" Icon="@Icons.Material.Outlined.Upload" Match="NavLinkMatch.All">Hosted Files</MudNavLink>
                    <MudNavLink Class="py-2" href="Objectives" Icon="@Icons.Material.Outlined.Checklist" Match="NavLinkMatch.All">Objectives</MudNavLink>
                    <MudNavLink Class="py-2" href="Settings" Icon="@Icons.Material.Outlined.Settings" Match="NavLinkMatch.All">Settings</MudNavLink>
                </MudNavMenu>
            </MudDrawer>
        }
        <MudMainContent Class="px-4">
            @Body
        </MudMainContent>
    </MudLayout>
}
else
{
    <MudMainContent Class="px-4">
        @Body
    </MudMainContent>
}

@code {
    [Inject]
    public NavigationManager Nav { get; set; }
    public static string TeamServerStatus { get; set; } = "Unknown";
    private bool isDrawerOpen = true;
    // We need to make the setter private to disallow outsiders from changing its value
    public static bool IsDarkMode { get; private set; } = true;
    //public string globalSearch { get; set; }
    public GlobalPalette globalPalette {get; set;}
    private HotKeysContext? HotKeysContext;

    private MudTheme theDefaultTheme = new MudTheme()
    {
        Palette = new PaletteLight()
        {
            Primary = "#FF8C00",
            Secondary = "#0073FF",
            Tertiary = "#8C73FF",
            Warning = "#880E4F",
            Surface = "rgba(0,0,0,0)",
            DrawerBackground = "rgba(0,0,0,0)",
            AppbarBackground = "#FF8C00",
            Success = "#3DCB6C",
            TextPrimary = "rgba(0,0,0, 0.90)",
            TextSecondary = "rgba(0,0,0, 0.50)",

        },
        PaletteDark = new PaletteDark()
        {
            Black = "#27272f",
            Background = "#1A1A27",
            BackgroundGrey = "#27272f",
            Surface = "rgba(0,0,0,0)",
            DrawerBackground = "rgba(0,0,0,0)",
            DrawerText = "rgba(255,255,255, 0.50)",
            DrawerIcon = "rgba(255,255,255, 0.50)",
            AppbarBackground = "#FF8C00",
            AppbarText = "rgba(255,255,255, 0.70)",
            TextPrimary = "rgba(255,255,255, 0.90)",
            TextSecondary = "rgba(255,255,255, 0.50)",
            ActionDefault = "#adadb1",
            ActionDisabled = "rgba(255,255,255, 0.26)",
            ActionDisabledBackground = "rgba(255,255,255, 0.12)",
            Primary = "#FF8C00",
            Secondary = "#0073FF",
            Tertiary = "#8C73FF",
            Warning = "#880E4F",
            Success = "#3DCB6C",
        }
    };

    private void NavigateToSettings()
    {
        Nav.NavigateTo("/Settings");
    }

    private void ToggleDrawer()
    {
        isDrawerOpen = !isDrawerOpen;
    }

    private async Task ChangeThemeAsync(bool? NewSetting)
    {
        IsDarkMode = NewSetting ?? false;
        await LocalStorageService.SetItemAsStringAsync("IsDarkMode", IsDarkMode.ToString());
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (await LocalStorageService.ContainKeyAsync("IsDarkMode"))
        {
            IsDarkMode = Convert.ToBoolean(await LocalStorageService.GetItemAsStringAsync("IsDarkMode"));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var TeamserverIp = HardHatHubClient.TeamserverIp;
        HttpClient http = new HttpClient(new HttpClientHandler { ServerCertificateCustomValidationCallback = (sender, cert, chain, sslPolicyErrors) => true });
        HttpResponseMessage response;

        //register global keyboard shortcuts
        HotKeysContext = HotKeys.CreateContext();
        HotKeysContext.Add(ModCode.Ctrl, Code.P , () =>
        {
            globalPalette.globalPaletteMode = GlobalPalette.GlobalPaletteMode.Command;
            globalPalette._textField.FocusAsync();
            StateHasChanged();
        }, 
        "Open command palette");
        HotKeysContext.Add(ModCode.Ctrl, Code.S , () =>
        {
            globalPalette.globalPaletteMode = GlobalPalette.GlobalPaletteMode.Search;
            globalPalette._textField.FocusAsync();      
        }, 
            "Open command palette in doc search mode");


        try
        {
            //every 30 seconds using a timer make a Get request to TeamserverIp/swagger to get the status of the teamserver
            var timer = new Timer(async (state) =>
            {
                try
                {
                    response = await http.GetAsync($"{TeamserverIp}/swagger");
                    TeamServerStatus = response.StatusCode == HttpStatusCode.OK ? "Online" : "Offline";
                }
                catch (Exception)
                {
                    TeamServerStatus = "Unknown";
                }
            }, null, 0, 30000);
        }
        catch (Exception)
        {
            TeamServerStatus = "Unknown";
        }

        if (Login.SignedInUser == null && Nav.Uri != Nav.BaseUri)
        {
            try
            {
                Nav.NavigateTo(Nav.BaseUri, true, true);
            }
            catch (Exception ex)
            {
            }
        }
    }

    public void Dispose()
    {
        this.HotKeysContext?.Dispose();
    }
}